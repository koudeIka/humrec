jQuery(document).ready(function() {

	function initFiche(rel_id)
	{
			$('#release_edit .sublab_id select')
					.unbind()
					.change(function() {
						$.post(
							"ajax/releases.ajax.php",
							{
									action: "save_sublab_id",
									rel_id: rel_id,
									sublab_id: $(this).val()
							}
						);
					});

			$('#release_edit .art_id select')
					.unbind()
					.change(function() {
// 						$('.release[data-rel_id="'+rel_id+'"] h2').html($('#release_edit .rel_number input').val()+" | ".$('#release_edit .art_id select').text());
						$.post(
							"ajax/releases.ajax.php",
							{
									action: "save_art_id",
									rel_id: rel_id,
									art_id: $(this).val()
							}
						);
					});


			$('#release_edit .rel_number input')
					.unbind()
					.hover(
						function()
						{
							$(this).addClass("ui-state-hover");
						},
						function()
						{
							$(this).removeClass("ui-state-hover");
						}
					)
					.focusin(
						function()
						{
							$(this).addClass("ui-state-active");
						}
					)
					.focusout(
						function()
						{
							$(this).removeClass("ui-state-active");
						}
					)
					.keyup(function() {
// 						$('.release[data-rel_id="'+rel_id+'"] h2').html($('#release_edit .rel_number input').val()+" | ".$('#release_edit .art_id select').v());
						$.post(
							"ajax/releases.ajax.php",
							{
									action: "save_rel_number",
									rel_id: rel_id,
									rel_number: $(this).val()
							}
						);
					});

			$('#release_edit .rel_title input')
					.unbind()
					.hover(
						function()
						{
							$(this).addClass("ui-state-hover");
						},
						function()
						{
							$(this).removeClass("ui-state-hover");
						}
					)
					.focusin(
						function()
						{
							$(this).addClass("ui-state-active");
						}
					)
					.focusout(
						function()
						{
							$(this).removeClass("ui-state-active");
						}
					)
					.keyup(function() {
						$.post(
							"ajax/releases.ajax.php",
							{
									action: "save_rel_title",
									rel_id: rel_id,
									rel_title: $(this).val()
							}
						);
					});

				$('#release_edit .rel_date input').datepicker({
					dateFormat: "dd/mm/yy",
					onSelect: function(dateText, inst) {
							$.post(
								"ajax/releases.ajax.php",
								{
										action: "save_rel_date",
										rel_id: rel_id,
										rel_date: dateText
								}
						);

					}
			});

			$('#release_edit .rel_description_fr textarea').cleditor({
					width:        660, // width not including margins, borders or padding
					height:       250, // height not including margins, borders or padding
					controls:     // controls to add to the toolbar
						"bold italic underline strikethrough subscript superscript | font size " +
						" | color highlight removeformat | bullets numbering | outdent " +
						"indent | alignleft center alignright justify | " +
						"rule image link unlink ",
				})
				.change(function() {
					var editor = $('#release_edit .rel_description_fr textarea').cleditor()[0];
					editor.updateTextArea();
					$.post(
						"ajax/releases.ajax.php",
						{
							action: "save_rel_description",
							rel_id: rel_id,
							rel_description_fr: $('#release_edit .rel_description_fr textarea').val()
						}
					);
				});
			$('#release_edit .rel_description_fr textarea').cleditor()[0].refresh();

			$('#release_edit .rel_description_en textarea').cleditor({
				width:        660, // width not including margins, borders or padding
				height:       250, // height not including margins, borders or padding
				controls:     // controls to add to the toolbar
					"bold italic underline strikethrough subscript superscript | font size " +
					" | color highlight removeformat | bullets numbering | outdent " +
					"indent | alignleft center alignright justify | " +
					"rule image link unlink ",
			})
			.change(function() {
				var editor = $('#release_edit .rel_description_en textarea').cleditor()[0];
				editor.updateTextArea();
				$.post(
					"ajax/releases.ajax.php",
				{
						action: "save_rel_description",
						rel_id: rel_id,
						rel_description_en: $('#release_edit .rel_description_en textarea').val()
				}
				);
			});
			$('#release_edit .rel_description_en textarea').cleditor()[0].refresh();

			$('#release_edit .rel_download input')
					.unbind()
					.hover(
						function()
						{
							$(this).addClass("ui-state-hover");
						},
						function()
						{
							$(this).removeClass("ui-state-hover");
						}
					)
					.focusin(
						function()
						{
							$(this).addClass("ui-state-active");
						}
					)
					.focusout(
						function()
						{
							$(this).removeClass("ui-state-active");
						}
					)
					.keyup(function() {
						$.post(
							"ajax/releases.ajax.php",
							{
									action: "save_rel_download",
									rel_id: rel_id,
									rel_download: $(this).val()
							}
						);
					});

			$('#release_edit .rel_paypal input')
					.unbind()
					.hover(
						function()
						{
							$(this).addClass("ui-state-hover");
						},
						function()
						{
							$(this).removeClass("ui-state-hover");
						}
					)
					.focusin(
						function()
						{
							$(this).addClass("ui-state-active");
						}
					)
					.focusout(
						function()
						{
							$(this).removeClass("ui-state-active");
						}
					)
					.keyup(function() {
						$.post(
							"ajax/releases.ajax.php",
							{
									action: "save_rel_paypal",
									rel_id: rel_id,
									rel_paypal: $(this).val()
							}
						);
					});
	}


	function initList()
	{
			$('#liste_releases .button_delete')
				.unbind()
				.button({
					text: false,
					icons: {
						primary: "ui-icon-trash"
					}
				})
				.click(function() {
					var that_div = $(this).closest("div");
					if(confirm("Êtes vous sûr de supprimer cet release et donc les releases qui en dépendent  ?"))
					{
						var rel_id = that_div.data("rel_id");
						that_div.slideUp("fast", function() { $(this).remove(); })
						$.post(
							"ajax/releases.ajax.php",
							{
								action: "delete_release",
								rel_id: rel_id
							}
						);
					}
				});

			$('#liste_releases .rel_show').unbind().click(function() {
				var rel_show = $(this).attr("checked");
				var rel_id = $(this).closest("div").data("rel_id");
				$.post(
					"ajax/releases.ajax.php",
					{
						action: "save_show",
						rel_id: rel_id,
						rel_show: rel_show
					}
				);
			});

			$('#liste_releases .release').unbind().dblclick(function() {

					if ($(this).hasClass("active"))
					{
						$('#liste_releases .release')
							.removeClass("hidden")
							.removeClass("active");
						$('#release_edit')
							.empty();

						$('#release_add').removeClass("hidden");
						$('#release_edit').addClass("hidden");

					} else
					{
						var rel_id = $(this).closest("div.release").data("rel_id");
						$('#release_edit').load(
							"ajax/releases.ajax.php",
							{
								action: "load_release",
								rel_id : rel_id,
							},
							function() {
								initFiche(rel_id);
							}
						);
						$(this)
							.addClass("active")
							.siblings(".release").addClass("hidden");
						$('#release_edit').removeClass("hidden");
						$('#release_add').addClass("hidden");
					}
			});
	}

	function initAdd()
	{
		$('#release_add')
			.unbind()
			.button({
				text: true,
				icons: {
					primary: "ui-icon-plusthick"
				}
			})
			.click(function() {

					$.post(
						"ajax/releases.ajax.php",
						{
							action: "add_new"
						},
						function(data)
						{
							var tmp = data.split(":::");
							$('#liste_releases').append(tmp[1]);
							initList();
							$('#rel_id_'+tmp[0]).dblclick();
						}
					);
			});
	}

	initAdd();
	initList();
});